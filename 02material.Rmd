---
title: "Material e métodos"
output: html_document
---



```{r, echo=FALSE}
require(rstanarm) #Bayes
require(dplyr) #Manipulação de dados
require(tidyverse)#Manipulação de dados
require(forestmangr) # Distribuição diamétrica
require(readr) # abrir arquivos excel
require(benford.analysis) # Análise de benford
require(ggplot2) #Criação de gráficos
require(scales) #Edição de gráficos
require(vegan) # Índices de diversidade
require(outliers) #Detecção de outliers
require(moments) #Curtose e assimetria

```


# Áreas de estudo

```{r prepDados}
invMerged = read_csv("./data/invMerged.csv")

calcVtcc = function(dap){                                                      
  return(0.51168+0.000911*dap^2)  
}

invMerged$vol = calcVtcc(invMerged$DBH) 
```


Selecionando area para extração das métricas...

```{r selecArea}
inv = invMerged %>% filter(area == 'BON_A01') %>% filter(year == '2014')
```


Análise exploratória da base de dados

```{r analiseExplor}
#Número de parcelas
N_par = length(unique(inv$plot))

# Número de árvores amostradas
N_arv = nrow(inv)

# Volume por hectare
vol_h = inv %>%
  group_by(plot) %>%
  summarise(vol = sum(vol * eqTree)) %>%
  summarize(mean(vol))

Media = mean(inv$DBH)
Mediana = median(inv$DBH)

DAP_maximo = max(inv$DBH)
Desvio_padrao = sd(inv$DBH)
Coef_Var = ((Desvio_padrao/Media)*100)

q1_DAP = quantile(inv$DBH, 0.25) 
q3_DAP = quantile(inv$DBH, 0.75)
iqr_DAP = IQR(inv$DBH)
ass_DAP = skewness(inv$DBH)
cur_DAP = kurtosis(inv$DBH)

dadosReferencia = data.frame(inv = "BON_A01_2014_Inventory",
                             nParc = N_par,
                             nArv = N_arv,
                             volHa = round(vol_h,2),
                             dapAvg = round(Media,2),
                             dapMd = round(Mediana,2),
                             dapMax = round(DAP_maximo,2),
                             dapDp = round(Desvio_padrao,2),
                             dapCv = round(Coef_Var,2),
                             dapQ1 = round(q1_DAP,2),
                             dapQ3 = round(q3_DAP,2),
                             dapIqr = round(iqr_DAP,2),
                             dapAss = round(ass_DAP,2),
                             dapCur = round(cur_DAP,2))
```


Ajustar modelo de Meyer para obter parâmetros da distribuição diamétrica...

```{r meyer}

distDiam = inv %>%
  group_by(plot, cc) %>%
  summarise(logNarv = log(sum(eqTree)))

lmMeyer = lm(logNarv ~ cc, data=distDiam)
  
dadosReferencia$meyerB0 = coef(lmMeyer)[1]
dadosReferencia$meyerB1 = coef(lmMeyer)[2]
```

Caluclar quociente de Liocourt para o inventário...

```{r liocourt}
distDiam = inv %>%
  group_by(plot, cc) %>%
  summarise(nArv = sum(eqTree)) %>%
  group_by(cc) %>%
  summarise(nArv = sum(nArv)/length(unique(inv$plot)))

distDiam$q = NA
for(i in distDiam$cc){
  if((i+10) %in% distDiam$cc){
    distDiam[distDiam$cc == i, 3] = distDiam[distDiam$cc == i, 2] / distDiam[distDiam$cc == i+10, 2]} 
  else {
    distDiam[distDiam$cc == i, 3] = NA
  }
}

dadosReferencia$licourt = mean(na.omit(distDiam$q))
```

Aplicando a Lei de Benford ao primeiro dígito DAP...

```{r benford}
benf1 = benford(inv$DBH,
               number.of.digits = 1)

benf2 = benford(inv$DBH,
               number.of.digits = 2)

dadosReferencia$benf1Mad = benf1$MAD
dadosReferencia$benf2Mad = benf2$MAD

distfamilia = inv %>%
  group_by(plot, family.name) %>%
  summarise(nArv = sum(eqTree)) %>%
  group_by(family.name) %>%
  summarise(nArv = sum(nArv)/length(unique(inv$plot)))

benfFam = benford(distfamilia$nArv,
               number.of.digits = 1)
dadosReferencia$benfFam = benfFam$MAD

distGen = inv %>%
  group_by(plot, genera.name) %>%
  summarise(nArv = sum(eqTree)) %>%
  group_by(genera.name) %>%
  summarise(nArv = sum(nArv)/length(unique(inv$plot)))

benfGen = benford(distGen$nArv,
               number.of.digits = 1)
dadosReferencia$benfGen = benfGen$MAD

distEsp = inv %>%
  group_by(plot, scientific.name) %>%
  summarise(nArv = sum(eqTree)) %>%
  group_by(scientific.name) %>%
  summarise(nArv = sum(nArv)/length(unique(inv$plot)))

benfEsp = benford(distEsp$nArv,
               number.of.digits = 1)
dadosReferencia$benfEsp = benfEsp$MAD
```

Densidade de Kernel para espécie, genero e família... largura de banda, desvio padrão de kernel - suavização...

```{r kernel}
dkE = density(distfamilia$nArv)
dkG = density(distGen$nArv)
dkF = density(distEsp$nArv)

dadosReferencia$dkE = dkE$bw
dadosReferencia$dkG = dkG$bw
dadosReferencia$dkF = dkF$bw

```


Espécies mais abundantes como indicadoras...

```{r}
eoi = c("Aspidosperma excelsum",
        "Bertholletia excelsa",
        "Caryocar villosum",
        "Conceveiba guianensis",
        "Couratari guianensis",
        "Dinizia excelsa",
        "Dipteryx odorata",
        "Eperua rubiginosa",
        "Eschweilera coriacea",
        "Goupia glabra",
        "Manilkara huberi",
        "Micropholis venulosa",
        "Minquartia guianensis",
        "Nectandra rubra",
        "Qualea albiflora",
        "Sloanea grandiflora",
        "Tabebuia serratifolia")

cod = c("Ae",
        "Be",
        "Cv",
        "Cog",
        "Cug",
        "De",
        "Do",
        "Er",
        "Ec",
        "Gg",
        "Mh",
        "Mv",
        "Mg",
        "Nr",
        "Qa",
        "Sg",
        "Ts")

freq = inv %>%
  group_by(plot, scientific.name) %>%
  summarise(nArv = sum(eqTree)) %>%
  group_by(scientific.name) %>%
  summarise(freq = n()/length(unique(inv$plot))) %>%
  filter(scientific.name %in% eoi)

densidade = inv %>%
  group_by(plot, scientific.name) %>%
  summarise(nArv = sum(eqTree)) %>%
  group_by(scientific.name) %>%
  summarise(dens = sum(nArv)/length(unique(inv$plot))) %>%
  filter(scientific.name %in% eoi)

dominancia = inv %>%
  mutate(q = DBH*pi/40000) %>%
  group_by(plot, scientific.name) %>%
  summarise(AB = sum(q * eqTree)) %>%
  group_by(scientific.name) %>%
  summarise(dom = sum(AB)/length(unique(inv$plot))) %>%
  filter(scientific.name %in% eoi)

estrutura = data.frame(esp = eoi, cod = cod, freq = 0, dom = 0, den = 0)

for(i in freq$scientific.name){
  estrutura[estrutura$esp == i,3] = freq[freq$scientific.name == i,2]
  estrutura[estrutura$esp == i,5] = densidade[densidade$scientific.name == i,2]
  estrutura[estrutura$esp == i,4] = dominancia[dominancia$scientific.name == i,2]
}

estrutura = pivot_longer(
  estrutura,
  cols = c("freq", "dom", "den"),
  names_to = "estrutFloresta"
) %>% 
  mutate(estrut = paste0(cod,estrutFloresta))

estrutura = data.frame(estrut = estrutura$estrut, indice = estrutura$value)

estrutura = pivot_wider(
  estrutura,
  names_from = "estrut",
  values_from = "indice")


dadosReferencia = cbind(dadosReferencia, estrutura)
```

# Índice de Payandeh: 
```{r}
# Criando matriz de espécies nas colunas e parcelas nas linhas
Matriz_BON_A01_2014_Inventory = table(BON_A01_2014_Inventory$plot_ID, BON_A01_2014_Inventory$scientific_name)

# Número de indivíduos por espécie
N_especie = table(BON_A01_2014_Inventory$scientific_name)

#Calculo
MI = apply(Matriz_BON_A01_2014_Inventory,2,mean)
Ssquare = apply(Matriz_BON_A01_2014_Inventory,2,var)
Indice_Payandeh = Ssquare/MI
Indice_Payandeh

# Tabela com os resultados
tabela_IP = data.frame(Espécie=names(N_especie),
                          N_especie=as.vector(N_especie),
                          Indice_Payandeh = round(as.vector(Indice_Payandeh),1))

tabela_IP = tabela_IP[order(tabela_IP$Indice_Payandeh,decreasing = T),]

Tabela_de_Atributos$BE_PI = tabela_IP[tabela_IP$Espécie == "Bertholletia excelsa", 3] 

Tabela_de_Atributos$DO_PI = tabela_IP[tabela_IP$Espécie == "Dipteryx odorata", 3]

Tabela_de_Atributos$MH_PI = tabela_IP[tabela_IP$Espécie == "Manilkara huberi", 3]



# Bertholletia excelsa;(9) ~
# Dipteryx odorata;(29) ~
# Manilkara huberi;(49)~

```


# Modelo da densidade e diâmetro de Reineke (1933): 
```{r}
MDDR = data.frame(Inventário = "BON_A01_2014_Inventory",
                  g = 0,
                  N = 0,
                  d = 0)

BON_A01_2014_Inventory$g = ((BON_A01_2014_Inventory$DBH^2)* pi)/40000 

Modelo_R = sum(BON_A01_2014_Inventory$g)/nrow(BON_A01_2014_Inventory)

MDDR$g = Modelo_R
MDDR$N = nrow(BON_A01_2014_Inventory)
MDDR$d = sqrt((MDDR$g*(40000))/pi)

#reg = lm(log(N) ~ log(d), MDDR)
#summary(reg)

```


# Diversidade Alfa: 
```{r}
# Matriz de frequência das espécies
M_freq_BON_A01_2014_Inventory =  xtabs(~plot_ID+scientific_name, BON_A01_2014_Inventory)

#Número de indivíduos por parcela
N_ind_parc = rowSums(M_freq_BON_A01_2014_Inventory)

# Número total de indivíduos amostrados
N_ind_tot = sum(N_ind_parc)

# Número de espécies
N_sp_parc = specnumber(M_freq_BON_A01_2014_Inventory)

# Número de espécies total
N_sp_tot = specnumber(colSums(M_freq_BON_A01_2014_Inventory))

# Índice de Shannon para toda a comunidade
simpson = diversity(colSums(M_freq_BON_A01_2014_Inventory), index = 'shannon')

# Índice de simpson para toda a comunidade
shannon = diversity(colSums(M_freq_BON_A01_2014_Inventory), index = 'simpson')

# Equabilidade de Pielou para toda comunidade
pielou = shannon/log(N_sp_tot)

# Adicionando a Tabela de atributos

Tabela_de_Atributos$Simpson = round(simpson,2)
Tabela_de_Atributos$Shannon = round(shannon,2)
Tabela_de_Atributos$Pielou = round(pielou,2)
```


# Dectecção de outliers - Espécies de maior valor econômico   
```{r}
outliers_BE = BON_A01_2014_Inventory[BON_A01_2014_Inventory$scientific_name ==     "Bertholletia excelsa", ] 
OT_BE= boxplot(outliers_BE$DBH)

outliers_DO = BON_A01_2014_Inventory[BON_A01_2014_Inventory$scientific_name ==     "Dipteryx odorata", ] 
OT_DO= boxplot(outliers_DO$DBH)

outliers_MH = BON_A01_2014_Inventory[BON_A01_2014_Inventory$scientific_name ==     "Manilkara huberi", ]
OT_MH= boxplot(outliers_MH$DBH)

# Bertholletia excelsa;(9) ~
# Dipteryx odorata;(29) ~
# Manilkara huberi;(49)~


# Adicionando a de atributos
Tabela_de_Atributos$N_OT_BE = sum(OT_BE$group)
Tabela_de_Atributos$N_OT_DO = sum(OT_DO$group)
Tabela_de_Atributos$N_OT_MH = sum(OT_MH$group)



```




## A dúvida

```{r}
duvida = read.csv('./data/tapajos.csv')
duvida = duvida %>% filter(!is.na(ida))
```

O órgão ambiental do Pará, acabeu de receber um inventário como parte de um processo de intervenção ambiental. Com base no inventário, a empresa considerou para o manejo, uma taxa de crescimento diamétrica de `mean(na.omit(duvida$ida))` cm/ano.

O analista deseja saber se o valores de incremento apresentado pela empresa está dentro do que se conhece sobre a área. Para isto, ele vai usar a estatisticas Bayesiana para analisar os dados.

## Análise a posteriori

```{r}
post = stan_glm(ida ~ 1, 
                family = gaussian(link = 'identity'), 
                data = duvida,
                prior_intercept = normal(1, 0.20))
```

```{r}
plot(post)
```


```{r}
posterior_vs_prior(post, group_by_parameter = TRUE, prob = 0.9)
```

